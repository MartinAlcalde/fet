<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Functional Ear – Minimal Web</title>
<style>
  body { font-family: system-ui, sans-serif; max-width: 520px; margin: 32px auto; }
  h1 { font-size: 1.2rem; margin-bottom: 8px; }
  .row { display: flex; gap: 8px; margin: 12px 0; flex-wrap: wrap; }
  button { padding: 10px 14px; font-size: 16px; }
  .stat { margin-top: 8px; font-size: 14px; color: #333; }
  .feedback { height: 24px; margin-top: 8px; font-weight: 600; }

  /* Piano UI */
  .piano { position: relative; display: flex; gap: 2px; user-select: none; margin-top: 10px; }
  .piano.disabled { pointer-events: none; opacity: 0.7; }
  .key { position: relative; cursor: pointer; }
  .key.white { width: 64px; height: 160px; background: #fff; border: 1px solid #ccc; box-shadow: inset 0 -2px 0 rgba(0,0,0,0.06); }
  .key.black { position: absolute; left: 42px; top: 0; width: 36px; height: 100px; background: #111; border: 1px solid #000; z-index: 2; border-radius: 0 0 3px 3px; }
  .key.black::after { content: ""; position: absolute; inset: 0; box-shadow: inset 0 -2px 0 rgba(255,255,255,0.06); }
  .key.active { outline: 2px solid #3b82f6; }
  .key.correct { box-shadow: 0 0 0 2px #16a34a inset; }
  .key.wrong { box-shadow: 0 0 0 2px #dc2626 inset; }
  .key.hint { box-shadow: 0 0 0 2px #f59e0b inset; }
</style>
</head>
<body>
  <h1>Functional Ear – Minimal (C major, C–F)</h1>
  <div class="row">
    <button id="start">Start / Next</button>
    <label><input type="checkbox" id="resolve" checked /> Resolve to C</label>
  </div>
  <div id="piano" class="piano" aria-label="Piano C4–C5"></div>
  <div class="feedback" id="feedback"></div>
  <div class="stat" id="stat">Attempts: 0 | Correct: 0 | Accuracy: 0%</div>

<!-- Tone.js local for offline usage -->
<script src="./assets/lib/Tone.js"></script>
<!-- Embedded base64 piano samples for file:// usage -->
<script src="./assets/piano.base64.js"></script>
<script>
(() => {
  // ---------- Audio setup ----------
  let audioCtx;
  const startAudio = () => {
    if (audioCtx) return audioCtx;
    if (typeof Tone !== "undefined" && Tone.getContext) {
      audioCtx = Tone.getContext().rawContext;
    } else {
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    return audioCtx;
  };
  let sampler; // Tone.Sampler instance (lazy)
  let samplerReady = false;

  const midiToFreq = (m) => 440 * Math.pow(2, (m - 69) / 12);
  const NOTES = {
    // Core octave center
    C4: 60, Cs4: 61, D4: 62, Ds4: 63, E4: 64, F4: 65, Fs4: 66, G4: 67, Gs4: 68, A4: 69, As4: 70, B4: 71, C5: 72,
    // Additional tones for simple triad voicings
    B3: 59, G3: 55, D5: 74
  };
  const DEGREE_TO_MIDI = { 1: NOTES.C4, 2: NOTES.D4, 3: NOTES.E4, 4: NOTES.F4 };
  const MIDI_TO_NAME = { 55: "G3", 59: "B3", 60: "C4", 61: "C#4", 62: "D4", 63: "D#4", 64: "E4", 65: "F4", 66: "F#4", 67: "G4", 68: "G#4", 69: "A4", 70: "A#4", 71: "B4", 72: "C5", 74: "D5" };

  async function preloadSampler() {
    // Create and load the sampler without starting audio; ready before first click
    if (sampler || typeof Tone === "undefined") return;
    const B64 = (window.PIANO_BASE64 || {});
    sampler = new Tone.Sampler({
      // Data-URI anchors; Tone.js interpolates nearby pitches
      urls: {
        A2: B64.A2,
        A3: B64.A3,
        A4: B64.A4,
        A5: B64.A5,
        C3: B64.C3,
        C4: B64.C4,
        C5: B64.C5,
        C6: B64.C6,
      },
      release: 1.2,
      onload: () => {
        samplerReady = true;
        setFeedback("Listo. Presioná Start");
        setStartEnabled(true);
      },
      onerror: (e) => {
        samplerReady = false;
        setFeedback("Error cargando piano");
      }
    }).toDestination();
  }

  function playTone(midi, when, dur = 0.6, type = "sine", gainVal = 0.15) {
    // Require sample-based piano; if not ready, do nothing
    const name = MIDI_TO_NAME[midi];
    if (!(sampler && samplerReady && name)) return;
    const ctx = startAudio();
    const delay = Math.max(0, when - ctx.currentTime);
    const t = (typeof Tone !== "undefined" ? Tone.now() : 0) + delay;
    const vel = Math.max(0.05, Math.min(1, gainVal * 6));
    sampler.triggerAttackRelease(name, dur, t, vel);
  }

  function playChord(midis, when, dur = 0.7, type = "piano", chordGain = 0.24) {
    const perVoice = chordGain / Math.max(1, midis.length);
    midis.forEach(m => playTone(m, when, dur, type, perVoice));
  }

  // Cadence: I–IV–V–I in C major (simple triads with smooth voice-leading)
  function playCadence() {
    const ctx = startAudio();
    const t0 = ctx.currentTime + 0.05;
    const step = 0.65;
    // I: C major (C4 E4 G4)
    playChord([NOTES.C4, NOTES.E4, NOTES.G4], t0, step, "piano");
    // IV: F major voiced with common tone C4 (C4 F4 A4)
    playChord([NOTES.C4, NOTES.F4, NOTES.A4], t0 + step, step, "piano");
    // V: G major (B3 D4 G4) for smooth motion
    playChord([NOTES.B3, NOTES.D4, NOTES.G4], t0 + 2*step, step, "piano");
    // I: C major return
    playChord([NOTES.C4, NOTES.E4, NOTES.G4], t0 + 3*step, step, "piano");
    return t0 + 4*step; // end time
  }

  // ---------- Game state ----------
  const state = {
    running: false,
    targetDegree: null,
    attempts: 0,
    correct: 0,
    answersEnabled: false,
  };

  const ui = {
    feedback: document.getElementById("feedback"),
    stat: document.getElementById("stat"),
    resolve: document.getElementById("resolve"),
    startBtn: document.getElementById("start"),
    piano: document.getElementById("piano"),
  };

  function updateStats() {
    const acc = state.attempts ? Math.round((100 * state.correct) / state.attempts) : 0;
    ui.stat.textContent = `Attempts: ${state.attempts} | Correct: ${state.correct} | Accuracy: ${acc}%`;
  }

  function setFeedback(text, ok = null) {
    ui.feedback.textContent = text;
    ui.feedback.style.color = ok === null ? "#333" : ok ? "green" : "crimson";
  }

  function setPianoEnabled(on) {
    state.answersEnabled = !!on;
    ui.piano.classList.toggle('disabled', !on);
  }

  function setStartEnabled(on) {
    ui.startBtn.disabled = !on;
  }

  function randTargetDegree() {
    const choices = [1, 2, 3, 4];
    return choices[Math.floor(Math.random() * choices.length)];
  }

  // Start/Next cycle
  ui.startBtn.addEventListener("click", async () => {
    if (!samplerReady) {
      setFeedback("Cargando piano…");
      return;
    }
    await Tone.start(); // unlock audio context on gesture
    startAudio();
    if (state.targetDegree) return; // ignore if a target is already active (awaiting answer)
    setStartEnabled(false);
    setPianoEnabled(false);
    setFeedback("Cadence…", null);
    const endCad = playCadence();
    const ctx = startAudio();
    // Choose target after cadence completes
    state.targetDegree = randTargetDegree();
    const tTarget = endCad + 0.12;
    playTone(DEGREE_TO_MIDI[state.targetDegree], tTarget, 0.9, "piano", 0.18);
    // Enable answers slightly after target onset
    const enableAtMs = Math.max(0, (tTarget - ctx.currentTime) * 1000) + 120;
    setTimeout(() => {
      setFeedback("What degree? (1–4)");
      setPianoEnabled(true);
      // Briefly highlight the target key
      highlightKey(DEGREE_TO_MIDI[state.targetDegree], 300);
    }, enableAtMs);
  });

  // Piano click answers
  function onPianoClick(e) {
    const keyEl = e.target.closest('[data-midi]');
    if (!keyEl || !state.answersEnabled || !state.targetDegree) return;
    const midi = Number(keyEl.dataset.midi);
    const degreeMap = { [NOTES.C4]: 1, [NOTES.D4]: 2, [NOTES.E4]: 3, [NOTES.F4]: 4 };
    const chosenDegree = degreeMap[midi] || null;
    if (!chosenDegree) {
      setFeedback('Solo C–F en este modo');
      flashKey(keyEl, 'wrong');
      return;
    }
    const ok = chosenDegree === state.targetDegree;
    state.attempts++;
    if (ok) state.correct++;
    setFeedback(ok ? '✓ Correct' : `✗ Wrong (it was ${state.targetDegree})`, ok);
    updateStats();
    flashKey(keyEl, ok ? 'correct' : 'wrong');

    // Optional resolution to C
    if (ui.resolve.checked) {
      const ctx = startAudio();
      const t0 = ctx.currentTime + 0.05;
      playTone(DEGREE_TO_MIDI[state.targetDegree], t0, 0.45, 'piano', 0.16);
      playTone(NOTES.C4, t0 + 0.46, 0.8, 'piano', 0.18);
    }

    // clear target so user must press Start/Next
    state.targetDegree = null;
    setPianoEnabled(false);
    setStartEnabled(true);
  }
  ui.piano.addEventListener('click', onPianoClick);

  // Keyboard shortcuts Enter + number keys map to white keys C–F
  window.addEventListener("keydown", (e) => {
    if (e.key === "Enter") ui.startBtn.click();
    const map = { '1': NOTES.C4, '2': NOTES.D4, '3': NOTES.E4, '4': NOTES.F4 };
    if (map[e.key]) clickMidi(map[e.key]);
  });

  updateStats();
  setPianoEnabled(false);
  buildPiano();
  setStartEnabled(false);
  setFeedback("Cargando piano…");
  // Preload samples; onload will enable Start
  preloadSampler();

  // ---------- Piano UI helpers ----------
  function buildPiano() {
    const whites = [NOTES.C4, NOTES.D4, NOTES.E4, NOTES.F4, NOTES.G4, NOTES.A4, NOTES.B4, NOTES.C5];
    ui.piano.innerHTML = '';
    ui.piano.className = 'piano';
    const hasSharpAfter = (midi) => {
      // Sharps after C, D, F, G, A within the octave
      const pc = midi % 12; // 0=C, 2=D, 4=E, 5=F, 7=G, 9=A, 11=B
      return pc === 0 || pc === 2 || pc === 5 || pc === 7 || pc === 9;
    };
    whites.forEach((midi) => {
      const key = document.createElement('div');
      key.className = 'key white';
      key.dataset.midi = String(midi);
      key.dataset.note = MIDI_TO_NAME[midi] || '';
      ui.piano.appendChild(key);
      if (hasSharpAfter(midi)) {
        const blackMidi = midi + 1;
        const black = document.createElement('div');
        black.className = 'key black';
        black.dataset.midi = String(blackMidi);
        black.dataset.note = MIDI_TO_NAME[blackMidi] || '';
        key.appendChild(black);
      }
    });
  }

  function clickMidi(midi) {
    const el = ui.piano.querySelector(`[data-midi="${midi}"]`);
    if (el) el.click();
  }

  function flashKey(el, cls, ms = 250) {
    el.classList.add('active', cls);
    setTimeout(() => el.classList.remove('active', cls), ms);
  }

  function highlightKey(midi, ms = 300) {
    const el = ui.piano.querySelector(`[data-midi="${midi}"]`);
    if (el) flashKey(el, 'hint', ms);
  }
})();
</script>
</body>
</html>
